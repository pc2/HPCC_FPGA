

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEMM &mdash; HPCC FPGA Documentation  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=53b48696" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GEMM FPGA Benchmark Results" href="results/index.html" />
    <link rel="prev" title="FFT FPGA Benchmark Results" href="../FFT/results/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            HPCC FPGA Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Benchmark Descriptions:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../STREAM/index.html">STREAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RandomAccess/index.html">RandomAccess</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FFT/index.html">FFT</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">GEMM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="results/index.html">GEMM FPGA Benchmark Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-parameters">Configuration Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#detailed-description">Detailed Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#expected-bottlenecks">Expected Bottlenecks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-hints">Configuration Hints</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../PTRANS/index.html">PTRANS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LINPACK/index.html">LINPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../b_eff/index.html">b_eff</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical Support:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../technical_support/Basic%20Setup/index.html">Basic Build Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../technical_support/Host%20Input%20Parameters/index.html">Execution of a Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../technical_support/Project%20Structure/index.html">Structure of the Benchmark Suite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../technical_support/json_output/index.html">JSON Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../technical_support/multi_fpga/index.html">Multi-FPGA Benchmarking</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Benchmark Results:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../FFT/results/index.html">FFT FPGA Benchmark Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="results/index.html">GEMM FPGA Benchmark Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RandomAccess/results/index.html">RandomAccess FPGA Benchmark Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../STREAM/results/index.html">STREAM FPGA Benchmark Results</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HPCC FPGA Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">GEMM</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <section id="gemm">
<span id="id1"></span><h1>GEMM<a class="headerlink" href="#gemm" title="Link to this heading"></a></h1>
<p>This section contains all information related to the GEMM benchmark.
This benchmark calculates the result for <span class="math notranslate nohighlight">\(C' = \beta \cdot C + \alpha \cdot A \cdot B\)</span> where <span class="math notranslate nohighlight">\(A,B,C,C' \in \Bbb R^{n \times n}\)</span> and <span class="math notranslate nohighlight">\(\alpha, \beta \in \Bbb R\)</span>.
The kernel uses a two-leveled blocked approach that can be individually scaled to the target hardware.</p>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="results/index.html">GEMM FPGA Benchmark Results</a></li>
</ul>
</div>
<section id="configuration-parameters">
<h2>Configuration Parameters<a class="headerlink" href="#configuration-parameters" title="Link to this heading"></a></h2>
<p>In <a class="reference internal" href="#gemm-config"><span class="std std-numref">Table 9</span></a> the configuration parameters are shown that are used to modify the kernel.
All other parameters can also later be changed with the host code during runtime.</p>
<span id="gemm-config"></span><table class="docutils align-default" id="id2">
<caption><span class="caption-number">Table 9 </span><span class="caption-text">Configuration parameters for the Kernel</span><a class="headerlink" href="#id2" title="Link to this table"></a></caption>
<colgroup>
<col style="width: 37.5%" />
<col style="width: 62.5%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NUM_REPLICATIONS</span></code></p></td>
<td><p>Replicates all kernels the given number of times. This allows to simultaneously schedule multiple kernels with different input data. The data set might be split between the available kernels to speed up execution.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">BLOCK_SIZE</span></code></p></td>
<td><p>Size of the matrix blocks that are buffered in local memory.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code></p></td>
<td><p>Size of the smaller matrix blocks that are multiplied in registers.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">GLOBAL_MEM_UNROLL</span></code></p></td>
<td><p>Unrolling factor for the loops that read or write to global memory. This modifies the width of the load and store units to optimize memory accesses.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">INTEL_MUL_SHIFT_REG</span></code></p></td>
<td><p>This parameters specifies the size of the shift register that is used within the multiplication pipeline. This allows to relax memory dependencies and increase the final kernel frequency. If the value is set to 0, no shift register will be used. This parameter is only relevant for Intel devices.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DATA_TYPE</span></code></p></td>
<td><p>Specifies the used data type for the calculation. <code class="docutils literal notranslate"><span class="pre">half</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code> and <code class="docutils literal notranslate"><span class="pre">double</span></code> are supported.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="detailed-description">
<h2>Detailed Description<a class="headerlink" href="#detailed-description" title="Link to this heading"></a></h2>
<p>The GEMM benchmark implements a matrix-matrix multiplication similar to the GEMM routines in the BLAS library.
It calculates <span class="math notranslate nohighlight">\(C' = \beta \cdot C + \alpha \cdot A \cdot B\)</span> where <span class="math notranslate nohighlight">\(A,B,C,C' \in \Bbb R^{n \times n}\)</span> and <span class="math notranslate nohighlight">\(\alpha, \beta \in \Bbb R\)</span>.
The number of FLOP for the performance calculation is defined to be <span class="math notranslate nohighlight">\(2 \cdot n^3\)</span>.
The result is verified by calculating the residual <span class="math notranslate nohighlight">\(\frac{||C - C'||}{\epsilon \cdot n \cdot ||C||_F}\)</span> where <span class="math notranslate nohighlight">\(\epsilon\)</span> is the machine epsilon and <span class="math notranslate nohighlight">\(C'\)</span> the result of the reference implementation.
The implementation is based on a matrix multiplication design for Intel Stratix 10 and generalized to make it compatible with a broader range of devices.
The kernel creates a memory hierarchy by doing the following data movements:</p>
<ul class="simple">
<li><p>A blocked matrix multiplication in global memory over a matrix of size n</p></li>
<li><p>A blocked matrix multiplication in local memory (BRAM) over blocks of size <code class="docutils literal notranslate"><span class="pre">BLOCK_SIZE</span></code></p></li>
<li><p>A fully unrolled matrix multiplication in registers over blocks of size <code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code></p></li>
</ul>
<p>The data movements and used pipelines are shown in the <a class="reference internal" href="#memory"><span class="std std-numref">Fig. 5</span></a> .</p>
<figure class="align-center" id="id3">
<span id="memory"></span><a class="reference internal image-reference" href="../_images/kernel_memory_hierarchy.drawio.png"><img alt="Impact of parameters to split the matix into blocks" src="../_images/kernel_memory_hierarchy.drawio.png" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Visualized data movements for the multiplication of two matrices A and B. These movements are implemented in two pipelines that will run sequentially.</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The matrices are divided into blocks of a fixed size that can be modified with the <code class="docutils literal notranslate"><span class="pre">BLOCK_SIZE</span></code> parameter.
One pipeline loads a single block of matrix A and B into the local memory of the FPGA.
In the second pipeline the loaded blocks are used to calculate an intermediate result again with a blocked approach.
This time the block size is defined by the parameter <code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code>.
The matrix multiplication for this block will be fully unrolled which allows to initiate the multiplication of a whole block every clock cycle.
Both pipelines will be executed sequentially to calculate a result of a single block of A + B.
A third pipeline loads a block of C and calculates the final result for a block of C’.</p>
</section>
<section id="expected-bottlenecks">
<h2>Expected Bottlenecks<a class="headerlink" href="#expected-bottlenecks" title="Link to this heading"></a></h2>
<p>Matrix multiplications are very compute-intensive, so the benchmark is expected to be mostly computation-bound.
Nevertheless, the two main pipelines that are executed sequentially are both, memory-bound (load data from global memory) and compute-bound (calculate on data).
The total execution time of the first pipeline is – depending on the chosen block size – considerably smaller than for the calculation pipeline.
So the benchmark will in the end be affected by both, the memory bandwidth and the calculation performance of the unrolled multiplication.
The calculation performance again is highly depending on the used FPGA resource and the final kernel frequency.
In consequence, the benchmark performance is also depending on the route and place capabilities of the development tools.</p>
<p>Together with the third pipeline, that is used to write the final result of a block back to global memory, the execution time can be modelled as given in <a class="reference internal" href="#equation-eq-gemm-performance">Eq.2</a>.</p>
<div class="math notranslate nohighlight" id="equation-eq-gemm-performance">
<span class="eqno">(2)<a class="headerlink" href="#equation-eq-gemm-performance" title="Link to this equation"></a></span>\[t_{exe} = \frac{b^2}{u \cdot f_{mem}} + \frac{b^3}{g^3 \cdot f_k} + \frac{b^2}{u \cdot \frac{n}{b} \cdot f_{mem}}\]</div>
<dl class="simple">
<dt>where</dt><dd><p><span class="math notranslate nohighlight">\(b\)</span> equals <code class="docutils literal notranslate"><span class="pre">BLOCK_SIZE</span></code>,
<span class="math notranslate nohighlight">\(r\)</span> equals <code class="docutils literal notranslate"><span class="pre">NUM_REPLICATIONS</span></code>,
<span class="math notranslate nohighlight">\(u\)</span> equals <code class="docutils literal notranslate"><span class="pre">GLOBAL_MEM_UNROLL</span></code> and
<span class="math notranslate nohighlight">\(g\)</span> equals <code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code></p>
</dd>
</dl>
<p>Moreover, <span class="math notranslate nohighlight">\(n\)</span> is the total matrix size, <span class="math notranslate nohighlight">\(f_k\)</span> the kernel frequency and <span class="math notranslate nohighlight">\(f_{mem}\)</span> the frequency of the memory interface.</p>
</section>
<section id="configuration-hints">
<h2>Configuration Hints<a class="headerlink" href="#configuration-hints" title="Link to this heading"></a></h2>
<p>The benchmark is mainly calculation bound.
The most stressed resources are DSPs and BRAM, since they are needed to increase parallelism of the calculation and the pipeline depth.
A larger local memory buffer leads to lesser reads and writes to global memory and thus reduces the overhead these operations are introducing.
In general, the parameters for the GEMM benchmark should be choosen after the following criteria:</p>
<ol class="arabic simple">
<li><p>Choose the data type with the <code class="docutils literal notranslate"><span class="pre">DATA_TYPE</span></code> parameter.</p></li>
<li><p>Scale <code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code> to the largest power of two that fits onto the FPGA since this parameters sets the actual amount of calculations that will be done in parallel. The size might depend on the chosen data type, since DSPs might not be usable for all precisions.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">BLOCK_SIZE</span></code> to the largest power of two that fits into the local memory of the FPGA. This will lead to a better utilization of the calculation pipeline.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">GLOBAL_MEM_UNROLL</span></code> parameter should be set to match the optimal width of the memory interface depending on the used data type. Check the reports how the load pipeline will be synthesized. In some cases it might be better to set <code class="docutils literal notranslate"><span class="pre">GLOBAL_MEM_UNROLL</span></code> to the same value as <code class="docutils literal notranslate"><span class="pre">GEMM_SIZE</span></code> since there will be no performance gain for higher values.</p></li>
<li><p>For Intel devices, check the estimated kernel frequency in the report. If it is too low or the calculation pipeline shows an II larger than 1, the shift register should be used. Choose a value larger 0 for <code class="docutils literal notranslate"><span class="pre">INTEL_MUL_SHIFT_REG</span></code> until frequency and II are in an acceptable range.</p></li>
<li><p>Replicate the kernel using the <code class="docutils literal notranslate"><span class="pre">NUM_REPLICATIONS</span></code> parameter to fill the FPGA. It might be better to pick smaller block sizes and instead replicate the kernel to make placing and routing easier.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
    <a href="https://github.com/pc2/hpcc_fpga">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
    </a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../FFT/results/index.html" class="btn btn-neutral float-left" title="FFT FPGA Benchmark Results" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="results/index.html" class="btn btn-neutral float-right" title="GEMM FPGA Benchmark Results" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Marius Meyer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>